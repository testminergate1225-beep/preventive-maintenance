<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="icon" type="image/x-icon" href="images/favicon.ico">
  <title>Megger Test Viewer</title>
  <style>
    body{font-family:Arial,Helvetica,sans-serif;margin:0;color:#111;background:#f4f6f8}
    .container{max-width:900px;margin:24px auto;padding:16px;background:#fff;border-radius:8px;box-shadow:0 2px 8px rgba(0,0,0,0.08)}
    h2{margin-bottom:12px}
    .toolbar{display:flex;gap:10px;margin-bottom:18px}
    .btn{background:#0b78d1;color:#fff;border:0;padding:8px 14px;border-radius:4px;cursor:pointer;font-size:14px;font-weight:500}
    .btn.secondary{background:#eee;color:#111;border:1px solid #ccc}
    table{width:100%;border-collapse:collapse;margin-top:10px}
    th,td{border:1px solid #ddd;padding:8px;font-size:13px;text-align:left}
    th{background:#f4f6f8}
    tr:hover{background:#f0f8ff}
    .empty{text-align:center;color:#888;padding:40px;font-size:15px}
    @media (max-width:700px){.container{padding:6px}.btn{padding:6px 8px;font-size:12px}th,td{padding:6px;font-size:11px}}
    @media print{.toolbar,.btn{display:none}}
  </style>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
  <script src="firebase-config.js"></script>
  <script src="auth-guard.js"></script>
</head>
<body>
  <div class="container">
    <h2>Megger Test Files</h2>
    <div class="toolbar">
      <button class="btn" onclick="window.location.href='megger_test_form.html'">+ New Test</button>
      <button class="btn secondary" onclick="location.reload()">Refresh List</button>
    </div>
    <div id="file-list"></div>
    <div id="empty-list" class="empty" style="display:none">No saved megger test files found.</div>
  </div>
  <script>
    const STORAGE_KEY = 'megger_test_files_v1';
    // Each file: {name, data, savedAt}
    function loadFileList() {
      try {
        const raw = localStorage.getItem(STORAGE_KEY);
        if (!raw) return [];
        const arr = JSON.parse(raw);
        return Array.isArray(arr) ? arr : [];
      } catch(e) { return []; }
    }
    function saveFileList(arr) {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(arr));
    }
    function renderFileList() {
      const files = loadFileList();
      const listDiv = document.getElementById('file-list');
      const emptyDiv = document.getElementById('empty-list');
      if (!files || files.length === 0) {
        listDiv.innerHTML = '';
        emptyDiv.style.display = 'block';
        return;
      }
      emptyDiv.style.display = 'none';
      let html = '<table><thead><tr><th>File Name</th><th>Date Saved</th><th>Actions</th></tr></thead><tbody>';
      files.forEach((f, idx) => {
        html += `<tr><td>${escapeHTML(f.name)}</td><td>${f.savedAt ? new Date(f.savedAt).toLocaleString() : ''}</td><td>` +
          `<button class='btn secondary' onclick='viewFile(${idx})'>View</button> ` +
          `<button class='btn secondary' onclick='printFile(${idx})'>Print</button> ` +
          `<button class='btn' onclick='editFile(${idx})'>Edit</button>` +
          `</td></tr>`;
      });
      html += '</tbody></table>';
      listDiv.innerHTML = html;
    }
    function escapeHTML(s) {
      return String(s).replace(/[&<>\"]/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c]));
    }
    function viewFile(idx) {
      const files = loadFileList();
      const rec = files[idx]?.data;
      if (!rec) return alert('File not found.');
      const w = window.open('', '_blank');
      w.document.write(renderPrintable(rec));
      w.document.close();
    }
    function printFile(idx) {
      const files = loadFileList();
      const rec = files[idx]?.data;
      if (!rec) return alert('File not found.');
      const html = renderPrintable(rec);
      const blob = new Blob([html],{type:'text/html'});
      const url = URL.createObjectURL(blob);
      const w = window.open(url, '_blank');
      setTimeout(()=>URL.revokeObjectURL(url), 2000);
    }
    function editFile(idx) {
      sessionStorage.setItem('megger_edit_idx', idx);
      window.location.href = 'megger_test_form.html';
    }
    function renderPrintable(r){
      function esc(s){ return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;'); }
      let rowsHtml = '';
      (r.rows||[]).forEach(row=>{
        rowsHtml += `<tr><td>${esc(row.panel)}</td><td>${esc(row.branch)}</td><td>${esc(row['L1-L2'])}</td><td>${esc(row['L1-L3'])}</td><td>${esc(row['L2-L3'])}</td><td>${esc(row['L1-N'])}</td><td>${esc(row['L2-N'])}</td><td>${esc(row['L3-N'])}</td><td>${esc(row['L1-G'])}</td><td>${esc(row['L2-G'])}</td><td>${esc(row['L3-G'])}</td><td>${esc(row['N-G'])}</td><td>${esc(row.wire)}</td><td>${esc(row.remarks)}</td></tr>`;
      });
      const html = `<!doctype html><html><head><meta charset='utf-8'><title>Megger Test Print</title><style>body{font-family:Arial;padding:10px}.report-header{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:10px}.reference-no{text-align:right;font-weight:bold}table{width:100%;border-collapse:collapse}th,td{border:1px solid #000;padding:6px;text-align:left}th{background:#f4f4f4}</style></head><body>`+
        `<div class='report-header'><div><h3 style='margin:0'>Megger Test Report</h3><div><strong>Company:</strong> ${esc(r.company)} &nbsp;&nbsp; <strong>Location:</strong> ${esc(r.location)}</div><div><strong>Date:</strong> ${esc(r.date)} &nbsp;&nbsp; <strong>Voltage:</strong> ${esc(r.testVoltage)}</div></div><div class='reference-no'>${r.referenceNo ? 'REF NO: ' + esc(r.referenceNo) : ''}</div></div>`+
        `<table><thead><tr><th>PANEL</th><th>BRANCH CKT #</th><th>L1-L2</th><th>L1-L3</th><th>L2-L3</th><th>L1-N</th><th>L2-N</th><th>L3-N</th><th>L1-G</th><th>L2-G</th><th>L3-G</th><th>N-G</th><th>WIRE</th><th>REMARKS</th></tr></thead><tbody>${rowsHtml}</tbody></table>`+
        `<div style='margin-top:24px;display:flex;gap:18px;justify-content:space-between'>`+
          `<div style='flex:1;text-align:center;'>`+
            `<div style='border-bottom:1px solid #000;height:28px;margin-bottom:8px'></div>`+
            `<div style='font-weight:700'>${esc(r.conductedBy) || '&nbsp;'}</div>`+
            `<div style='font-size:12px;color:#444'>Conducted By</div>`+
            `<div style='font-size:12px;color:#444;margin-top:6px'>Date: ${esc(r.date)||''}</div>`+
          `</div>`+
          `<div style='flex:1;text-align:center;'>`+
            `<div style='border-bottom:1px solid #000;height:28px;margin-bottom:8px'></div>`+
            `<div style='font-weight:700'>${esc(r.witnessedBy) || '&nbsp;'}</div>`+
            `<div style='font-size:12px;color:#444'>Witnessed By</div>`+
            `<div style='font-size:12px;color:#444;margin-top:6px'>Date: ${esc(r.date)||''}</div>`+
          `</div>`+
          `<div style='flex:1;text-align:center;'>`+
            `<div style='border-bottom:1px solid #000;height:28px;margin-bottom:8px'></div>`+
            `<div style='font-weight:700'>${esc(r.verifiedBy) || '&nbsp;'}</div>`+
            `<div style='font-size:12px;color:#444'>Verified By</div>`+
            `<div style='font-size:12px;color:#444;margin-top:6px'>Date: ${esc(r.date)||''}</div>`+
          `</div>`+
        `</div><scr`+`ipt>window.print()</scr`+`ipt></body></html>`;
      return html;
    }
    document.addEventListener('DOMContentLoaded', renderFileList);
  </script>
</body>
</html>

