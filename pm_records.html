<!doctype html>
<html lang="en">
<head>
	<meta charset="utf-8"/>
	<meta name="viewport" content="width=device-width,initial-scale=1"/>
	<link rel="icon" type="image/x-icon" href="images/favicon.ico">
	<title>PM Records - Backup Viewer</title>
	<style>
		*{margin:0;padding:0;box-sizing:border-box}
		:root{--bg:#f9fafb;--card:#fff;--accent:#0b78d1;--muted:#6b7280}
		body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;background:var(--bg);color:#111;padding:20px}
		.container{max-width:1400px;margin:0 auto}
		h1{font-size:24px;margin-bottom:8px;color:#111}
		.subtitle{color:var(--muted);font-size:14px;margin-bottom:20px}
		.toolbar{display:flex;gap:10px;margin-bottom:16px;flex-wrap:wrap}
		button{background:var(--accent);color:#fff;border:0;padding:10px 16px;border-radius:6px;cursor:pointer;font-size:14px;font-weight:500;transition:all 0.2s}
		button:hover{opacity:0.9;transform:translateY(-1px)}
		button.secondary{background:#e5e7eb;color:#111}
		.card{background:var(--card);border-radius:8px;box-shadow:0 1px 3px rgba(0,0,0,0.1);padding:20px;margin-bottom:20px}
		table{width:100%;border-collapse:collapse;font-size:13px}
		th,td{text-align:left;padding:10px;border-bottom:1px solid #e5e7eb}
		th{background:#f3f4f6;font-weight:600;position:sticky;top:0}
		tr:hover{background:#f9fafb}
		.empty{text-align:center;color:var(--muted);padding:40px;font-size:14px}
		@media (max-width:768px){
			body{padding:10px}
			h1{font-size:18px}
			.subtitle{font-size:12px}
			.toolbar{gap:6px}
			button{padding:8px 12px;font-size:12px}
			.card{padding:12px}
			table{display:block;overflow-x:auto;-webkit-overflow-scrolling:touch;font-size:11px}
			th,td{padding:6px;white-space:nowrap}
		}
		@media print{.toolbar{display:none}}
	</style>
	<!-- Firebase SDK -->
	<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
	<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
	<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
	<script src="firebase-config.js"></script>
	<script src="auth-guard.js"></script>
</head>
<body>
	<div class="container">
		<h1>PM Records - Backup Viewer</h1>
		<p class="subtitle">View, export, and manage your preventive maintenance records</p>
		
		<div class="toolbar">
			<button onclick="window.location.href='index.html'">‚Üê Back to App</button>
			<button onclick="openPreventiveMaintenanceRecord()">Open Preventive Maintenance Record</button>
			<button onclick="openBackupFile()">Open Json / CSV Backup</button>
			<button class="secondary" onclick="downloadJSON()">Download JSON</button>
			<button class="secondary" onclick="exportCSV()">Export CSV</button>
			<button class="secondary" onclick="printAsPDF()">Print / Save PDF</button>
			<button class="secondary" onclick="window.open('YOUR_ONEDRIVE_BACKUP_URL_HERE','_blank')">Download from OneDrive</button>
		</div>
		<input type="file" id="backup-file-input" accept=".json,.csv" style="display:none" />

		<div class="card">
			<div id="table-container"></div>
			<div id="empty" class="empty" style="display:none">No records found. Return to the main app to add records.</div>
		</div>
	</div>

	<script>
		const KEY = 'epm_records_v1';

		async function loadRecords(){
			return await FirestoreDB.loadRecords(KEY);
		}

		async function renderTable(){
			const records = await loadRecords();
			const container = document.getElementById('table-container');
			const emptyEl = document.getElementById('empty');

			if(records.length === 0){
				container.innerHTML = '';
				emptyEl.style.display = 'block';
				return;
			}

			emptyEl.style.display = 'none';

			let html = '<table><thead><tr>';
			html += '<th>Date</th>';
			html += '<th>Branch Code</th>';
			html += '<th>Branch Name</th>';
			html += '<th>Equipment</th>';
			html += '<th>Location</th>';
			html += '<th>Task</th>';
			html += '<th>Status</th>';
			html += '<th>Performed By</th>';
			html += '<th>Verified By</th>';
			html += '<th>Next Due</th>';
			html += '<th>Notes</th>';
			html += '</tr></thead><tbody>';

			records.forEach(rec => {
				html += '<tr>';
				html += `<td>${escapeHTML(rec.date || '')}</td>`;
				html += `<td>${escapeHTML(rec.BranchCode || '')}</td>`;
				html += `<td>${escapeHTML(rec.BranchName || '')}</td>`;
				html += `<td>${escapeHTML(rec.equipment || '')}</td>`;
				html += `<td>${escapeHTML(rec.location || '')}</td>`;
				html += `<td>${escapeHTML(rec.task || '')}</td>`;
				html += `<td>${escapeHTML(rec.status || '')}</td>`;
				html += `<td>${escapeHTML(rec.performedBy || '')}</td>`;
				html += `<td>${escapeHTML(rec.verifiedBy || '')}</td>`;
				html += `<td>${escapeHTML(rec.nextDue || '')}</td>`;
				html += `<td>${escapeHTML(rec.notes || '')}</td>`;
				html += '</tr>';
			});

			html += '</tbody></table>';
			container.innerHTML = html;
		}

		function escapeHTML(str){
			const div = document.createElement('div');
			div.textContent = str;
			return div.innerHTML;
		}

		async function downloadJSON(){
			const records = await loadRecords();
			const blob = new Blob([JSON.stringify(records, null, 2)], {type:'application/json'});
			const url = URL.createObjectURL(blob);
			const a = document.createElement('a');
			a.href = url;
			a.download = `pm_records_backup_${new Date().toISOString().split('T')[0]}.json`;
			a.click();
			URL.revokeObjectURL(url);
		}

		async function exportCSV(){
			const records = await loadRecords();
			if(records.length === 0){
				alert('No records to export');
				return;
			}

			const headers = ['Date','Branch Code','Branch Name','Equipment','Location','Task','Status','Performed By','Verified By','Next Due','Notes'];
			let csv = headers.join(',') + '\n';

			records.forEach(rec => {
				const row = [
					rec.date || '',
					rec.BranchCode || '',
					rec.BranchName || '',
					rec.equipment || '',
					rec.location || '',
					rec.task || '',
					rec.status || '',
					rec.performedBy || '',
					rec.verifiedBy || '',
					rec.nextDue || '',
					rec.notes || ''
				];
				csv += row.map(field => `"${(field+'').replace(/"/g,'""')}"`).join(',') + '\n';
			});

			const blob = new Blob([csv], {type:'text/csv'});
			const url = URL.createObjectURL(blob);
			const a = document.createElement('a');
			a.href = url;
			a.download = `pm_records_${new Date().toISOString().split('T')[0]}.csv`;
			a.click();
			URL.revokeObjectURL(url);
		}

		function printAsPDF(){
			window.print();
		}

		function openPreventiveMaintenanceRecord(){
			// Force load and display all records from localStorage
			renderTable();
			
			const records = loadRecords();
			if(records.length > 0){
				alert(`Loaded ${records.length} preventive maintenance record(s)`);
			} else {
				alert('No records found in local storage. Please add records in the main app first.');
			}
		}

		function openBackupFile(){
			const fileInput = document.getElementById('backup-file-input');
			fileInput.onchange = handleFileSelect;
			fileInput.click();
		}

		function handleFileSelect(event){
			const file = event.target.files[0];
			if(!file) return;

			const reader = new FileReader();
			const fileName = file.name.toLowerCase();

			if(fileName.endsWith('.json')){
				reader.onload = function(e){
					try{
						const data = JSON.parse(e.target.result);
						if(Array.isArray(data)){
							mergeAndPersist(data);
						} else {
							alert('Invalid JSON format. Expected an array of records.');
						}
					}catch(err){
						alert('Failed to parse JSON file: ' + err.message);
					}
				};
				reader.readAsText(file);
			} else if(fileName.endsWith('.csv')){
				reader.onload = function(e){
					try{
						const csv = e.target.result;
						const records = parseCSV(csv);
						if(records.length > 0){
							mergeAndPersist(records);
						} else {
							alert('No records found in CSV file.');
						}
					}catch(err){
						alert('Failed to parse CSV file: ' + err.message);
					}
				};
				reader.readAsText(file);
			} else {
				alert('Please select a JSON or CSV file.');
			}

			// Reset input
			event.target.value = '';
		}

		function parseCSV(csv){
			const lines = csv.split('\n').filter(line => line.trim());
			if(lines.length < 2) return [];

			const headers = lines[0].split(',').map(h => h.trim().replace(/^"|"$/g, '').toLowerCase());
			const records = [];

			for(let i = 1; i < lines.length; i++){
				const values = parseCSVLine(lines[i]);
				if(values.length === 0) continue;

				const record = {};
				headers.forEach((header, idx) => {
					if(idx < values.length){
						record[header] = values[idx];
					}
				});
				records.push(record);
			}

			return records;
		}

		function parseCSVLine(line){
			const result = [];
			let current = '';
			let inQuotes = false;

			for(let i = 0; i < line.length; i++){
				const char = line[i];
				const nextChar = line[i + 1];

				if(char === '"'){
					if(inQuotes && nextChar === '"'){
						current += '"';
						i++;
					} else {
						inQuotes = !inQuotes;
					}
				} else if(char === ',' && !inQuotes){
					result.push(current);
					current = '';
				} else {
					current += char;
				}
			}
			result.push(current);
			return result;
		}

		function mergeAndPersist(newRecords){
			if(!Array.isArray(newRecords) || newRecords.length === 0){
				alert('No valid records to merge');
				return;
			}

			const existing = loadRecords();
			const merged = [...existing];

			newRecords.forEach(newRec => {
				const isDup = existing.some(e => 
					e.date === newRec.date &&
					e.BranchCode === newRec.BranchCode &&
					e.BranchName === newRec.BranchName &&
					e.equipment === newRec.equipment &&
					e.task === newRec.task &&
					e.performedBy === newRec.performedBy
				);
				if(!isDup) merged.push(newRec);
			});

			localStorage.setItem(KEY, JSON.stringify(merged));
			alert(`Merged ${merged.length - existing.length} new record(s). Total: ${merged.length}`);
			renderTable();
		}

		// Initialize
		renderTable();
	</script>
</body>
</html>
